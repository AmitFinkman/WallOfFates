<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wall of Fates [MANAGER]</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Rubik:wght@500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .card {
            transform-style: preserve-3d;
            transition: transform 0.6s;
            cursor: pointer;
        }
        .card.is-flipped {
            transform: rotateY(180deg);
        }
        .card-face {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 0.5rem;
        }
        .card-face-back {
            transform: rotateY(180deg);
            background-color: #4a5568;
        }
        input[type="color"] {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            width: 44px; height: 44px;
            border: none; cursor: pointer; background-color: transparent;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: 2px solid #e2e8f0; border-radius: 0.5rem; }
        .palette-color.selected {
            transform: scale(1.15);
            box-shadow: 0 0 0 3px white, 0 0 15px white;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-7xl mx-auto">
        <div id="setup-screen" class="bg-gray-800 p-8 rounded-lg shadow-2xl transition-opacity duration-500">
            <h1 class="text-4xl font-bold text-center mb-2 text-white" style="font-family: 'Rubik', sans-serif;">Wall of Fates Setup</h1>
            <p class="text-center text-gray-400 mb-8">Set up your game board.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <div>
                        <label for="num-entries" class="block mb-2 text-sm font-medium text-gray-300">How many entries on the wall?</label>
                        <input type="number" id="num-entries" value="24" min="1" max="100" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5">
                    </div>
                    <div>
                        <label for="num-colors" class="block mb-2 text-sm font-medium text-gray-300">How many colors to use?</label>
                        <input type="number" id="num-colors" value="4" min="1" max="10" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5">
                    </div>
                </div>
                <div>
                    <label class="block mb-2 text-sm font-medium text-gray-300">Choose your colors</label>
                    <div id="color-pickers-container" class="flex flex-wrap gap-4 p-4 bg-gray-700 rounded-lg"></div>
                </div>
            </div>
            <div class="mt-8 text-center">
                <button id="start-game-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition-transform transform hover:scale-105 shadow-lg">
                    Build the Wall & Start Game
                </button>
            </div>
        </div>

        <div id="game-screen" class="hidden transition-opacity duration-500">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-white" style="font-family: 'Rubik', sans-serif;">Wall of Fates</h1>
                <div>
                    <button id="fullscreen-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition mr-2">Full Screen</button>
                    <button id="toggle-key-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition mr-2">Show Game Key</button>
                    <button id="reset-game-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition">New Game</button>
                </div>
            </div>

            <div class="mb-6">
                <p class="text-center text-gray-400 mb-3">Select a team color to claim an entry</p>
                <div id="team-color-palette" class="flex justify-center items-center flex-wrap gap-4 p-2 rounded-lg bg-gray-900/50"></div>
            </div>

            <div id="game-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-4"></div>

            <div id="game-key-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
                <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md max-h-[80vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Game Master's Key</h2>
                        <button id="close-key-btn" class="text-gray-400 hover:text-white">&times;</button>
                    </div>
                    <div id="game-key-content" class="text-left bg-gray-900 p-4 rounded-md"></div>
                    <div class="mt-4 text-right">
                        <button id="copy-key-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Copy Key</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const setupScreen = document.getElementById('setup-screen');
        const gameScreen = document.getElementById('game-screen');
        const numEntriesInput = document.getElementById('num-entries');
        const numColorsInput = document.getElementById('num-colors');
        const colorPickersContainer = document.getElementById('color-pickers-container');
        const startGameBtn = document.getElementById('start-game-btn');
        const resetGameBtn = document.getElementById('reset-game-btn');
        const teamColorPalette = document.getElementById('team-color-palette');
        const gameGrid = document.getElementById('game-grid');
        const gameKeyModal = document.getElementById('game-key-modal');
        const gameKeyContent = document.getElementById('game-key-content');
        const toggleKeyBtn = document.getElementById('toggle-key-btn');
        const closeKeyBtn = document.getElementById('close-key-btn');
        const copyKeyBtn = document.getElementById('copy-key-btn');
        const fullscreenBtn = document.getElementById('fullscreen-btn');

        const defaultColors = ['#4f46e5', '#db2777', '#d97706', '#16a34a', '#0891b2', '#6d28d9', '#4f46e5', '#db2777', '#d97706', '#16a34a'];
        let gameData = [];
        let activeColor = null;

        function generateColorPickers() {
            const numColors = parseInt(numColorsInput.value, 10);
            colorPickersContainer.innerHTML = '';
            for (let i = 0; i < numColors; i++) {
                const colorInput = document.createElement('input');
                colorInput.type = 'color';
                colorInput.className = 'color-picker rounded-lg';
                colorInput.value = defaultColors[i % defaultColors.length];
                colorPickersContainer.appendChild(colorInput);
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function generateSecretScores(count) {
            const scores = [];
            const scoreDistribution = [
                { score: 500, weight: 2 }, { score: 400, weight: 3 },
                { score: 300, weight: 4 }, { score: 200, weight: 5 },
                { score: 150, weight: 6 }, { score: 100, weight: 7 },
                { score: 0, weight: 8 }
            ];
            if (count > 0) { scores.push(1000); }
            const remainingCount = count - 1;
            if (remainingCount > 0) {
                const weightedPool = scoreDistribution.flatMap(item => Array(item.weight).fill(item.score));
                if (weightedPool.length === 0) { weightedPool.push(0); }
                for (let i = 0; i < remainingCount; i++) {
                    const randomIndex = Math.floor(Math.random() * weightedPool.length);
                    scores.push(weightedPool[randomIndex]);
                }
            }
            return scores;
        }

        function startGame() {
            const numEntries = parseInt(numEntriesInput.value, 10);
            const colorPickers = colorPickersContainer.querySelectorAll('.color-picker');
            const colors = Array.from(colorPickers).map(picker => picker.value);
            const secretNumbers = shuffleArray(generateSecretScores(numEntries));

            gameGrid.innerHTML = '';
            teamColorPalette.innerHTML = '';
            gameData = [];
            activeColor = null;

            colors.forEach(color => {
                const colorDiv = document.createElement('div');
                colorDiv.className = 'palette-color w-10 h-10 rounded-md cursor-pointer transition-transform';
                colorDiv.style.backgroundColor = color;
                colorDiv.dataset.color = color;
                colorDiv.addEventListener('click', (e) => {
                    document.querySelector('.palette-color.selected')?.classList.remove('selected');
                    e.currentTarget.classList.add('selected');
                    activeColor = e.currentTarget.dataset.color;
                });
                teamColorPalette.appendChild(colorDiv);
            });

            for (let i = 0; i < numEntries; i++) {
                const entryNumber = i + 1;
                // ✅ **FIX:** The gameData object now holds the complete state for each card.
                gameData.push({
                    entry: entryNumber,
                    secret: secretNumbers[i],
                    color: null,      // `null` means unclaimed
                    isFlipped: false  // `false` means face-down
                });
                
                const cardContainer = document.createElement('div');
                cardContainer.className = 'aspect-square relative';
                
                const card = document.createElement('div');
                card.className = 'card w-full h-full';
                card.dataset.entry = entryNumber;
                
                const cardFront = document.createElement('div');
                cardFront.className = 'card-face card-face-front';
                cardFront.style.backgroundColor = '#374151'; // Neutral gray start
                cardFront.innerHTML = `<span class="text-4xl font-bold text-white">${entryNumber}</span>`;
                
                const cardBack = document.createElement('div');
                cardBack.className = 'card-face card-face-back';
                cardBack.innerHTML = `<span class="text-4xl font-bold text-white">${secretNumbers[i]}</span>`;

                card.appendChild(cardFront);
                card.appendChild(cardBack);
                cardContainer.appendChild(card);
                gameGrid.appendChild(cardContainer);

                card.addEventListener('click', () => handleCardClick(card, cardFront));
            }
            
            populateGameKey();

            setupScreen.classList.add('opacity-0');
            setTimeout(() => {
                setupScreen.classList.add('hidden');
                gameScreen.classList.remove('hidden');
                gameScreen.classList.add('opacity-100');
            }, 500);
        }

        // ✅ **FIX:** This function's logic is rewritten to use `gameData` as the single source of truth.
        function handleCardClick(card, cardFront) {
            const entryNumber = parseInt(card.dataset.entry, 10);
            const entryData = gameData.find(item => item.entry === entryNumber);

            if (entryData.isFlipped) {
                return; // Card is already revealed, do nothing.
            }

            // Case 1: Card is already claimed (has a color), so the action is to flip it.
            if (entryData.color) {
                entryData.isFlipped = true;       // Update the data model
                card.classList.add('is-flipped'); // Update the view
            } 
            // Case 2: Card is unclaimed, so the action is to claim it.
            else {
                if (activeColor) {
                    entryData.color = activeColor;                // Update the data model
                    cardFront.style.backgroundColor = activeColor; // Update the view
                } else {
                    alert("Please select a team color first!"); // User feedback
                }
            }
        }

        function populateGameKey() {
            gameKeyContent.innerHTML = '';
            const sortedGameData = [...gameData].sort((a, b) => a.secret - b.secret);
            const list = document.createElement('ul');
            list.className = 'space-y-2 font-mono';
            sortedGameData.forEach(item => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `<pre>Entry #${String(item.entry).padStart(2, '0')} -> Reveals: ${String(item.secret).padStart(4, ' ')}</pre>`;
                list.appendChild(listItem);
            });
            gameKeyContent.appendChild(list);
        }

        function resetGame() {
            gameScreen.classList.remove('opacity-100');
            gameScreen.classList.add('hidden');
            setupScreen.classList.remove('hidden');
            setupScreen.classList.remove('opacity-0');
            gameKeyModal.classList.add('hidden');
        }
        
        function copyKeyToClipboard() {
            const keyText = gameData.map(item => `Entry #${item.entry} -> Reveals: ${item.secret}`).join('\n');
            navigator.clipboard.writeText(keyText).then(() => {
                const originalText = copyKeyBtn.textContent;
                copyKeyBtn.textContent = 'Copied!';
                setTimeout(() => { copyKeyBtn.textContent = originalText; }, 2000);
            }).catch(err => console.error('Failed to copy: ', err));
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => console.error(`Fullscreen error: ${err.message}`));
            } else if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        }
        
        // --- Event Listeners ---
        window.addEventListener('load', generateColorPickers);
        numColorsInput.addEventListener('change', generateColorPickers);
        startGameBtn.addEventListener('click', startGame);
        resetGameBtn.addEventListener('click', resetGame);
        toggleKeyBtn.addEventListener('click', () => gameKeyModal.classList.remove('hidden'));
        closeKeyBtn.addEventListener('click', () => gameKeyModal.classList.add('hidden'));
        copyKeyBtn.addEventListener('click', copyKeyToClipboard);
        fullscreenBtn.addEventListener('click', toggleFullScreen);
        gameKeyModal.addEventListener('click', (e) => {
            if (e.target === gameKeyModal) gameKeyModal.classList.add('hidden');
        });
    </script>
</body>
</html>
